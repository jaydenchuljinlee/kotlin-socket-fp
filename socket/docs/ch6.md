# π“ WebSocket κΈ°λ° μ±„ν… μ„λ²„: Redis μƒνƒ μ΄κ΄€ & λ¶€ν• ν…μ¤νΈ μ •λ¦¬

---

## β… 1. Redis κΈ°λ° ChatStateStore μ΄κ΄€

### π” κΈ°μ΅΄ κµ¬μ΅° (AS-IS)

- `InMemoryChatStateStore`μ—μ„ JVM λ‚΄μ—μ„ `ConcurrentHashMap`μΌλ΅ μƒνƒ μ €μ¥
- λ‹¨μ :
    - μ„λ²„ μ¬μ‹μ‘ μ‹ μƒνƒ μ†μ‹¤
    - λ‹¤μ¤‘ μΈμ¤ν„΄μ¤ ν™κ²½μ—μ„ μƒνƒ κ³µμ  λ¶κ°€
    - μ΄μ/ν…μ¤νΈ ν™κ²½μ—μ„ ν™•μ¥ μ–΄λ ¤μ›€

### β… κ°μ„  κµ¬μ΅° (TO-BE)

- Redis κΈ°λ° μƒνƒ μ €μ¥μ† `RedisChatStateStore` κµ¬ν„
- μ£Όμ” κΈ°λ¥:
    - `getState(roomId)`: Redis μ΅°ν
    - `updateState(roomId, state)`: Redis κ°±μ‹ 
    - `observeState(roomId)`: `Channel` + `Pub/Sub` λ°©μ‹ κµ¬ν„
    - λ°© μƒμ„±/μ‚­μ /μ΅°ν μ§€μ›

### π’΅ μ΄μ 

| ν•­λ©        | μ„¤λ… |
|-------------|------|
| μμ†μ„±       | μ„λ²„ μ¬μ‹μ‘μ—λ„ μƒνƒ μ μ§€ κ°€λ¥ |
| μν‰ ν™•μ¥    | μ—¬λ¬ μ„λ²„ κ°„ μƒνƒ κ³µμ  |
| λ¨λ‹ν„°λ§     | Redis key TTL, memory usage λ“± μ‚¬μ© κ°€λ¥ |
| ν™•μ¥μ„±       | Kafka λ“± μ΄λ²¤νΈ μ‹μ¤ν…κ³Ό μ—°κ³„ κ°€λ¥ |

---

## β… 2. WebSocket λ¶€ν• ν…μ¤νΈ μ΄μ λ° ν•΄κ²°

### β λ¬Έμ : SockJS ν™κ²½μ—μ„λ” μ„±λ¥ ν…μ¤νΈ λ„κµ¬ μ‚¬μ© λ¶κ°€

#### μ›μΈ

- `withSockJS()`λ” λΈλΌμ°μ € νΈν™μ„±μ„ μ„ν• **μ „μ© transport κ³„μΈµ**μ„ ν¬ν•¨
- STOMP λ©”μ‹μ§•λ„ ν…μ¤νΈ ν”„λ μ„ κΈ°λ°μ **νΉμν• ν”„λ΅ν† μ½**
- `k6`, `ws`, `websocket-client`, `JMeter` λ“±μ€ **SockJS handshake λ―Έμ§€μ›**

#### κ²°κ³Ό

- `WebSocket μ—°κ²° μ‹¤ν¨`, `ν”„λ μ„ drop`, `μ„λ²„ λ―Έλ„λ‹¬` ν„μƒ λ°μƒ

---

### β… ν•΄κ²°: SockJS μ κ±° ν›„ ν‘μ¤€ WebSocket μ „ν™

#### Spring Boot μ„¤μ • λ³€κ²½

```kotlin
override fun registerStompEndpoints(registry: StompEndpointRegistry) {
    registry.addEndpoint("/ws") // β withSockJS() μ κ±°
        .setAllowedOriginPatterns("*")
}
```

#### Vue.js ν΄λΌμ΄μ–ΈνΈ λ³€κ²½
```javascript
// λ³€κ²½ μ „
const socket = new SockJS('http://localhost:8080/ws')

// λ³€κ²½ ν›„
const socket = new WebSocket('ws://localhost:8080/ws')

```

## β… 3. μΌλ° WebSocket vs SockJS λΉ„κµ

| ν•­λ©                        | WebSocket                              | SockJS                                       |
|-----------------------------|-----------------------------------------|----------------------------------------------|
| **ν”„λ΅ν† μ½ ν‘μ¤€μ„±**        | β… RFC 6455 ν‘μ¤€ κΈ°λ°                   | β λΉ„ν‘μ¤€ ν”„λ΅ν† μ½ (fallback ν¬ν•¨)            |
| **λΈλΌμ°μ € νΈν™μ„±**        | μµμ‹  λΈλΌμ°μ €λ§ μ§€μ›                   | β… κµ¬ν• λΈλΌμ°μ €κΉμ§€ μ§€μ›                    |
| **Spring μ„¤μ • λ°©μ‹**       | `addEndpoint("/ws")`                   | `addEndpoint("/ws").withSockJS()`            |
| **μ—°κ²° λ°©μ‹**              | WebSocket μ§μ ‘ μ—°κ²° (`ws://`)         | HTTP long-polling, xhr-streaming, iframe λ“± |
| **ν…μ¤νΈ λ„κµ¬ νΈν™μ„±**     | β… k6, ws, JMeter, Gatling λ“± λ¨λ‘ μ§€μ› | β κ±°μ λ¨λ“  λ¶€ν• ν…μ¤νΈ λ„κµ¬μ™€ λ―ΈνΈν™       |
| **λ©”μ‹μ§• λ‹¨μμ„±**          | STOMP λ©”μ‹μ§€λ§ λ‹¤λ£¨λ©΄ λ¨              | SockJS ν”„λ΅ν† μ½ + STOMP λ‘ λ‹¤ κ³ λ ¤ ν•„μ”     |
| **μ΄μ ν™κ²½ ν™•μ¥μ„±**       | β… μ„λ²„ κ°„ λ¶„μ‚°, CDN κµ¬μ„± μ©μ΄         | β ν”„λ΅μ‹/λ΅λ“λ°Έλ°μ„ μ„¤μ •μ΄ λ³µμ΅             |
| **μ„±λ¥ λ° μ μ§€λ³΄μ**       | λΉ λ¥΄κ³  μ μ§€λ³΄μ μ‰¬μ›€                   | λ³µμ΅ν•κ³  λ””λ²„κΉ… μ–΄λ ¤μ›€                        |
| **μ‹¤λ¬΄ μ‚¬μ©**              | β… κ²μ„, μ±—, μ‹¤μ‹κ°„ λ€μ‹λ³΄λ“ λ“±        | β λ κ±°μ‹ IE λ€μ‘ μ™Έμ—λ” κ±°μ μ‚¬μ© μ• ν•¨     |

---

## π“ μ”μ•½

- `SockJS`λ” κµ¬ν• λΈλΌμ°μ € λ€μ‘μ—λ” μ λ¦¬ν•μ§€λ§, **μ„±λ¥ ν…μ¤νΈ/ν™•μ¥μ„±/νΈν™μ„± μΈ΅λ©΄μ—μ„ λ¶λ¦¬**ν•©λ‹λ‹¤.
- νΉν **k6 κ°™μ€ μ„±λ¥ μΈ΅μ • λ„κµ¬λ” SockJSλ¥Ό μΈμ‹ν•μ§€ λ»ν•λ―€λ΅ ν…μ¤νΈ μμ²΄κ°€ λ¶κ°€λ¥**ν•©λ‹λ‹¤.
- μ‹¤μ‹κ°„ μ›Ή μ• ν”λ¦¬μΌ€μ΄μ…, μ±„ν…, λ€μ‹λ³΄λ“, IoT λ“± **ν„λ€μ  ν™κ²½**μ—μ„λ” WebSocketλ§ μ‚¬μ©ν•λ” κ²ƒμ΄ λ°”λμ§ν•©λ‹λ‹¤.
